# Troubleshooting Guide

## Document Principles

- **Facts only** — No explanations beyond what's needed to understand and fix
- **Format** — Error → Cause → Solution
- **Keep compact** — One issue, one entry
- **Update** — Add new issues as discovered, remove obsolete ones

---

## WSL2 / Network Issues

### DNS Resolution Failures (EAI_AGAIN) — Discord Gateway Reconnect Loop

```
getaddrinfo EAI_AGAIN gateway-us-east1-c.discord.gg
WebSocket connection closed with code 1005
WebSocket connection closed with code 1006
TypeError: fetch failed
```

**Cause**: WSL2's auto-generated `/etc/resolv.conf` uses the Windows host's DNS server, which can be unreliable. This causes DNS resolution failures that break WebSocket connections (Discord gateway enters a reconnect loop with codes 1005/1006) and HTTP requests (`TypeError: fetch failed`).

**Solution** (automatic in new installations):
The installer configures a layered DNS approach:
1. Enables WSL2 DNS tunneling in `.wslconfig` (modern, recommended by Microsoft)
2. Writes a locked static `/etc/resolv.conf` fallback with Google + Cloudflare DNS
3. Sets `generateResolvConf=false` in `wsl.conf` to prevent WSL from overwriting it

**Manual fix for existing installations**:
```powershell
# 1. Enable DNS tunneling (run in PowerShell on Windows)
# Add to %USERPROFILE%\.wslconfig:
# [wsl2]
# dnsTunneling=true
```

```bash
# 2. In WSL (run: wsl -d openclaw)

# Prevent WSL from overwriting resolv.conf
sudo bash -c 'grep -q "\[network\]" /etc/wsl.conf && sed -i "/\[network\]/a generateResolvConf = false" /etc/wsl.conf || printf "\n[network]\ngenerateResolvConf = false\n" >> /etc/wsl.conf'

# 3. Restart WSL from PowerShell: wsl --shutdown

# 4. Set and lock stable DNS
sudo rm -f /etc/resolv.conf
sudo bash -c 'cat > /etc/resolv.conf << EOF
nameserver 8.8.8.8
nameserver 1.1.1.1
nameserver 8.8.4.4
EOF'
sudo chattr +i /etc/resolv.conf
```

**Verification**:
```bash
nslookup discord.gg
# Should resolve without errors
```

---

### ERR_SSL_CIPHER_OPERATION_FAILED

```
npm error code ERR_SSL_CIPHER_OPERATION_FAILED
npm error C04C4B8D9C730000:error:1C800066:Provider routines:ossl_gcm_stream_update:cipher operation failed
```

**Cause**: WSL2 network stack corrupts SSL data with concurrent connections (GitHub WSL #12340)

**Solution**:
```bash
npm config set maxsockets 1
npm config set fetch-retries 5
npm config set fetch-retry-mintimeout 20000
npm config set fetch-retry-maxtimeout 120000
```

**Alternative**: Download via Windows npm, transfer to WSL via shared folder

---

## PowerShell / Script Generation Issues

### The string is missing the terminator

**Symptom**: PowerShell script generated by LauncherGenerator fails with:
```
At D:\Git\OpenClaw-WSL\.local\scripts\launch-openclaw.ps1:34 char:186
+ ... `"[^`"]*`"' | head -1 | sed 's/.*`"token`": *`\"`([^`\"]*`)\"`/\1/'"
+                                                                        ~~
The string is missing the terminator: '.
```

**Cause**: Complex regex patterns with nested quotes in bash commands embedded in PowerShell scripts cause escaping conflicts. PowerShell's backtick escaping combined with bash quoting creates unresolvable syntax errors.

**Solution**: Use `jq` for JSON parsing instead of `grep | sed` chains:
```powershell
# BAD - escaping nightmare
$token = & wsl -- bash -lc "cat file.json | grep -o '`"token`": *`"[^`"]*`"' | sed 's/.*`"token`": *`\"`([^`\"]*`)\"`/\1/'"

# GOOD - clean and reliable
$token = & wsl -- bash -lc "jq -r '.gateway.auth.token' file.json"
```

**Note**: `jq` is installed by default in OpenClaw-WSL (included in required packages).

---

## PowerShell / Process Issues

### Console Display Corruption (Diagonal Text Pattern)

**Symptom**: Menu text appears in diagonal pattern across the screen, starting correctly aligned but each subsequent line shifts right:
```
╔═════════════════════════════════════════════════════════╗
                                                               ║
 ║
    ║     ██████╗  ██████╗      ██╗    ██╗███████╗██╗         ║
                                                                 ║    ██╔═══██╗██╔════╝...
```

**Cause**: Displaying output before a `while` loop that calls `Clear-Host` corrupts the console buffer when running through `cmd.exe → powershell.exe -File`. Specifically, this pattern breaks:
```powershell
function Show-MainMenu {
    Show-Banner              # First output
    Write-Host "Loading..."  # More output
    while ($true) {
        Show-SelectMenu -ShowBanner  # Calls Clear-Host, corrupts buffer
    }
}
```

The `Clear-Host` after initial output causes Windows console to miscalculate cursor positions in subprocess contexts.

**Solution**: Never output anything before the main menu loop. Let the loop's first iteration handle all display:
```powershell
function Show-MainMenu {
    while ($true) {
        Show-SelectMenu -ShowBanner  # First and only banner display
    }
}
```

**Note**: This only affects `cmd.exe → powershell.exe` subprocess chains. Running `.\Start.ps1` directly in PowerShell may work, but `Start.bat` (which uses cmd) will fail.

---

### Interactive Terminal Not Working with Start-Process

**Symptom**: `Start-Process -NoNewWindow -Wait` doesn't show interactive prompts, app exits immediately

**Cause**: `Start-Process` doesn't preserve TTY for interactive applications

**Solution**: Use direct command execution instead:
```powershell
# Bad
Start-Process -FilePath "wsl.exe" -ArgumentList "-d", $distro, "--", "bash", "-lc", "command" -NoNewWindow -Wait

# Good
& wsl.exe -d $distro -- bash -lc "command"
```

---

### .Trim() on Non-String Objects

```
Method invocation failed because [System.Management.Automation.ErrorRecord] does not contain a method named 'Trim'
```

**Cause**: WSL command returned error object instead of string

**Solution**: Use safe wrapper function:
```powershell
function Get-SafeTrimmedString {
    param($Value, [string]$Default = "")
    if ($null -eq $Value) { return $Default }
    if ($Value -is [string]) { return $Value.Trim() }
    try { return $Value.ToString().Trim() }
    catch { return $Default }
}
```

---

## WSL User/Permission Issues

### User Creation Fails Silently

**Symptom**: `useradd` runs but user doesn't exist

**Cause**: Running as wrong user or permission denied

**Solution**: Always run user creation as root:
```powershell
wsl -d $distro -u root -- useradd -m -s /bin/bash $username
wsl -d $distro -u root -- bash -c "echo '$username ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/$username"
```

---

### PATH Not Available in Login Shell

**Symptom**: `openclaw: command not found` even though installed

**Cause**: npm global bin not in PATH for login shells

**Solution**: Add to both `.bashrc` and `.profile`:
```bash
echo 'export PATH="$HOME/.npm-global/bin:$PATH"' >> ~/.bashrc
echo 'export PATH="$HOME/.npm-global/bin:$PATH"' >> ~/.profile
```

---

## OpenClaw Skill Installation Errors

> **Note**: On x86_64 (Intel/AMD) systems, some skills will fail due to architecture requirements.
> This is normal—most skills still work. Run `openclaw doctor` to see available skills.

### Skill fails: "unzip: No such file or directory"

**Cause**: `unzip` not installed; required by Homebrew to extract packages  
**Solution**: `sudo apt-get install -y unzip` (fixed in v2.0+ installations)

---

### Skill fails: "arm64 architecture is required"

**Cause**: Skill requires Apple Silicon Mac (e.g., `camsnap`, `summarize`, `1password`)  
**Solution**: Skip—these skills are macOS/arm64-only, won't work on WSL/x86_64

**Affected skills** (partial list):
- `camsnap` - macOS screen capture
- `summarize` - Apple Silicon native
- Some skills with native macOS binaries

**Note**: This is a hardware limitation. No software fix exists for x86_64 systems.

---

### Skill fails: "missing brew formula"

**Cause**: Several possibilities:
1. Skill uses `brew cask` which is macOS-only (e.g., `model-usage`)
2. Formula doesn't exist for Linux x86_64
3. Homebrew tap not available for your architecture

**Solution**: Skip—these skills require macOS or arm64 Linux

---

### Skill fails: "Broken pipe"

**Cause**: Network instability during download (e.g., `wacli`, `gifgrep`, `imsg`)  
**Solution**: Retry later or run manually: `brew install <formula>`

**Mitigation**: OpenClaw-WSL now sets `HOMEBREW_NO_INSTALL_FROM_API=1` which helps prevent this.

---

### Skill shows all ✔︎ bottles but still "Install failed"

**Example** (openai-whisper):
```
✔︎ Bottle pytorch (2.10.0)
✔︎ Bottle openai-whisper (20250625_3)
... (many bottles succeed)
Install failed: openai-whisper
```

**Cause**: **OpenClaw skill installer bug** — the actual `brew install` succeeds, but OpenClaw's post-install verification incorrectly reports failure.

**Verification**: The formula is actually installed! Check with:
```bash
/home/linuxbrew/.linuxbrew/bin/brew list <formula-name>
```

**Solution**:
1. **Ignore the error** — the package is likely installed correctly
2. Run `openclaw doctor` — it should detect the installed formula
3. If truly not installed, run manually:
   ```bash
   /home/linuxbrew/.linuxbrew/bin/brew install <formula-name>
   ```

**Note**: This is a known issue with OpenClaw's skill installer, not with Homebrew or the packages. Tested: `openai-whisper` installs successfully via brew even when OpenClaw reports failure.

---

### Systemd user services unavailable

**Cause**: systemd not enabled in WSL2 or user lingering not configured  
**Solution** (fixed in v2.0+ installations):

1. Enable systemd in `/etc/wsl.conf`:
   ```ini
   [boot]
   systemd=true
   ```

2. Restart WSL: `wsl --shutdown` then reopen

3. Enable user lingering:
   ```bash
   sudo loginctl enable-linger $USER
   ```

4. Verify lingering is enabled:
   ```bash
   loginctl show-user $USER | grep Linger
   # Should show: Linger=yes
   ```

**Note**: New installations automatically configure systemd and user lingering.

---

### Gateway Not Accessible from Windows (Connection Refused)

**Symptom**: Gateway is running inside WSL (`systemctl --user status openclaw-gateway.service` shows active) but Windows can't connect:
```
No connection could be made because the target machine actively refused it.
```

**Cause**: Gateway binds to `127.0.0.1` (loopback only) by default. Even with mirrored networking, Windows can't reach services bound to WSL's localhost.

**Solution**: Configure gateway to bind to all interfaces with `--bind lan`:
```bash
# In WSL
sed -i 's|gateway --port|gateway --bind lan --port|' ~/.config/systemd/user/openclaw-gateway.service
systemctl --user daemon-reload
systemctl --user restart openclaw-gateway.service
```

**Verification**:
```bash
# Should show 0.0.0.0:18789 (not 127.0.0.1:18789)
ss -tlnp | grep 18789
```

**Note**: New installations from OpenClaw-WSL v2.1+ automatically configure `--bind lan`.

---

### Gateway already running (pid X); lock timeout

**Symptom**:
```
Gateway failed to start: gateway already running (pid 280); lock timeout after 5000ms
Port 18789 is already in use.
Gateway service appears enabled. Stop it first.
```

**Cause**: OpenClaw's onboarding wizard enables a systemd user service (`openclaw-gateway.service`) that auto-starts when WSL boots. When the launcher tries to start another gateway, it conflicts.

**Solution** (Fixed in current version):
- OpenClaw-WSL now automatically disables the auto-start service after onboarding
- The launcher detects running gateways and opens the browser instead of failing

**If you see this on an older installation**:
```bash
# Disable the auto-start service
wsl -d openclaw -- systemctl --user stop openclaw-gateway.service
wsl -d openclaw -- systemctl --user disable openclaw-gateway.service

# Now the launcher will work correctly
```

**Alternative - Use the running gateway**:
If gateway is already running, just open the dashboard manually:
```
http://127.0.0.1:18789/?token=openclaw-local-token
```

---

### Gateway timeout after health check

**Cause**: Gateway couldn't start—usually due to missing systemd services or configuration  
**Solution**:
1. Ensure systemd is enabled (see above)
2. Restart WSL: `wsl --shutdown`
3. Run onboarding again: `openclaw onboard`
4. Verify gateway token is configured:
   ```bash
   cat ~/.openclaw/openclaw.json | jq '.gateway.auth'
   # Should show: { "mode": "token", "token": "openclaw-local-token" }
   ```

---

### Browser opens but shows authentication error

**Cause**: Gateway token mismatch between config and launcher URL  
**Solution**:
1. Check the token in OpenClaw config:
   ```bash
   cat ~/.openclaw/openclaw.json | jq -r '.gateway.auth.token'
   ```
2. The token should match `openclaw-local-token` (default)
3. If different, update the config:
   ```bash
   jq '.gateway.auth.mode = "token" | .gateway.auth.token = "openclaw-local-token"' \
     ~/.openclaw/openclaw.json > /tmp/oc.json && mv /tmp/oc.json ~/.openclaw/openclaw.json
   ```
4. Or change the launcher setting in `.local/settings.json`:
   ```json
   { "gateway": { "token": "your-token-here" } }
   ```

---

### Missing Control UI assets

```
Missing Control UI assets. Build them with `pnpm ui:build` (auto-installs UI deps).
```

**Cause**: Known bug with npm global installs ([GitHub #4855](https://github.com/openclaw/openclaw/issues/4855))  
**Solution**:
1. This is a symlink detection issue—assets exist but aren't found
2. Try running with full path:
   ```bash
   node ~/.npm-global/lib/node_modules/openclaw/openclaw.mjs gateway
   ```
3. Or wait for upstream fix in future OpenClaw versions
4. **Workaround**: Use the official installer instead of npm:
   ```bash
   curl -fsSL https://openclaw.ai/install.sh | bash
   ```

---

## Package Installation Issues

### Hash Sum Mismatch During apt-get

```
E: Failed to fetch http://archive.ubuntu.com/ubuntu/.../Packages Hash Sum mismatch
```

**Cause**: Ubuntu mirror servers temporarily out of sync during package updates

**Solution** (automatic): The install script now automatically switches to alternate mirrors when hash mismatches occur. Mirrors tried:
1. archive.ubuntu.com (default)
2. mirrors.edge.kernel.org
3. mirror.arizona.edu
4. mirror.math.princeton.edu

**Manual fix if needed**:
```bash
# Clean apt cache completely
apt-get clean
rm -rf /var/lib/apt/lists/*

# Switch mirror manually (replace with any Ubuntu mirror)
sed -i 's|http://archive.ubuntu.com/ubuntu|http://mirrors.edge.kernel.org/ubuntu|g' /etc/apt/sources.list

# Update and retry
apt-get update
apt-get install -y <packages>
```

---

### Homebrew Installation Failed

**Symptom**: "Homebrew installation failed" with unclear error

**Cause**: Usually because build tools (gcc, g++) failed to configure due to hash mismatch or dpkg errors

**Solution**: 
1. Fix apt package issues first (see Hash Sum Mismatch above)
2. Repair dpkg state:
```bash
sudo dpkg --configure -a
sudo apt --fix-broken install -y
```
3. Verify gcc works:
```bash
echo 'int main() { return 0; }' > /tmp/test.c && gcc /tmp/test.c -o /tmp/test && echo "OK"
```
4. Then install Homebrew manually:
```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

---

### Homebrew PATH Error: "No such file or directory"

**Symptom**: During installation, console shows:
```
bash: line 1: export HOMEBREW_PREFIX="/home/linuxbrew/.linuxbrew";
export HOMEBREW_CELLAR=...
export INFOPATH=...: No such file or directory
```

**Cause**: The `eval "$(brew shellenv)"` line wasn't written correctly to `.bashrc`/`.profile`. The `$()` in the eval command was being executed prematurely during variable assignment in bash.

**Solution** (Fixed in code): The installer now pipes base64-decoded content directly to file instead of storing in a variable. If you see this error on an existing install, manually fix:
```bash
# Remove broken entry
sed -i '/# Homebrew/,+2d' ~/.bashrc ~/.profile

# Add correct entry
printf '\n# Homebrew\neval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"\n' >> ~/.bashrc
printf '\n# Homebrew\neval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"\n' >> ~/.profile
```

---

### Broken Packages After WSL Import

**Symptom**: `apt-get install` fails with held broken packages

**Cause**: Imported distro may have incomplete package state

**Solution**:
```bash
apt-get update
apt-get -f install -y
dpkg --configure -a
```

---

### Node.js Native Modules Fail to Build

**Symptom**: `node-gyp` errors during npm install

**Cause**: Missing build tools

**Solution**: Install build dependencies:
```bash
apt-get install -y cmake build-essential python3
```

---

## Quick Reference Commands

```bash
# Reset WSL network state
wsl --shutdown

# Check npm config
npm config list

# Verify openclaw installation
~/.npm-global/bin/openclaw --version

# Run onboarding manually
openclaw onboard

# Check WSL distro status
wsl -l -v
```

---

### Gateway Start Blocked: gateway.mode=local Not Set

**Symptom**:
```
Gateway start blocked: set gateway.mode=local (current: unset) or pass --allow-unconfigured.
```

**Cause**: This error occurs when launching OpenClaw directly without the `--allow-unconfigured` flag and no configuration exists.

**Solution**: The launchers (`OpenClaw.bat`, Start.ps1) now use `--allow-unconfigured` which lets OpenClaw start and handle onboarding automatically. Simply use the provided launchers.

**If running manually**, add the flag:
```bash
openclaw gateway --allow-unconfigured
```

**Alternative - Manual Configuration**:
```bash
# In WSL (run: wsl -d openclaw)
openclaw config set gateway.mode local
openclaw config set gateway.auth.mode token
openclaw config set gateway.auth.token openclaw-local-token
```

---

## Ollama / AI Model Issues

### WSL Cannot Reach Ollama

**Symptom**: Menu shows "WSL cannot reach Ollama" even though Ollama is running on Windows

**Cause**: WSL2 uses a virtual network isolated from Windows. By default, WSL cannot reach Windows services on localhost.

**Solution (Recommended - Mirrored Networking)**:

The simplest fix is to enable WSL's mirrored networking mode. This allows WSL to use `localhost` to reach Windows services.

1. The launcher will offer to configure this automatically. Say "Yes" when prompted.
2. WSL will restart to apply changes.
3. After restart, WSL can reach Ollama at `localhost:11434`.

**Manual Setup**:
```powershell
# Create/edit %USERPROFILE%\.wslconfig with:
[wsl2]
networkingMode=mirrored

# Then restart WSL:
wsl --shutdown
```

**Verification**:
```bash
# From WSL (after enabling mirrored networking)
curl http://localhost:11434/api/tags
```

**Still not working?**
- Run `wsl --shutdown` then restart the launcher
- Restart Ollama from the system tray
- Verify Ollama is running: `ollama ps`

---

### Ollama Model Shows "System.Collections.Hashtable"

**Symptom**: Configuration shows `OLLAMA_MODEL = System.Collections.Hashtable` instead of model name

**Cause**: Bug in menu selection (fixed in later versions)

**Solution**: Update to latest version or manually set in WSL:
```bash
echo "export OLLAMA_MODEL='llama3.1:8b'" >> ~/.bashrc
source ~/.bashrc
```

---

### Unknown model: ollama/llama3.1:8b

**Symptom**: Gateway starts but shows `Unknown model: ollama/llama3.1:8b` when you try to chat

**Cause**: OpenClaw is missing the Ollama provider configuration. The `models.providers.ollama` section in `~/.openclaw/openclaw.json` tells OpenClaw how to connect to Ollama's OpenAI-compatible API.

**Background**: Normally `ollama launch openclaw --config` (run from Windows where Ollama is installed) configures this automatically. However, since OpenClaw runs in WSL, the Windows Ollama command configures the wrong config file (`C:\Users\<user>\.openclaw\openclaw.json` instead of the WSL one).

**Solution**: Add the Ollama provider configuration to the WSL OpenClaw config:

```bash
# In WSL (run: wsl -d openclaw)
# Edit ~/.openclaw/openclaw.json and add the "models" section:
```

```json
{
  "models": {
    "providers": {
      "ollama": {
        "api": "openai-completions",
        "apiKey": "ollama-local",
        "baseUrl": "http://localhost:11434/v1",
        "models": [
          {
            "contextWindow": 131072,
            "cost": { "cacheRead": 0, "cacheWrite": 0, "input": 0, "output": 0 },
            "id": "llama3.1:8b",
            "input": ["text"],
            "maxTokens": 16384,
            "name": "llama3.1:8b",
            "reasoning": false
          }
        ]
      }
    }
  }
}
```

**Note**: Replace `llama3.1:8b` with your actual model name (run `ollama list` on Windows to see available models).

**Alternative** (if you have jq installed):
```bash
# Add Ollama provider to existing config
jq '.models.providers.ollama = {
  "api": "openai-completions",
  "apiKey": "ollama-local", 
  "baseUrl": "http://localhost:11434/v1",
  "models": [{"id": "llama3.1:8b", "name": "llama3.1:8b", "contextWindow": 131072, "maxTokens": 16384, "input": ["text"], "reasoning": false, "cost": {"input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0}}]
}' ~/.openclaw/openclaw.json > /tmp/oc.json && mv /tmp/oc.json ~/.openclaw/openclaw.json
```

**Verification**:
```bash
# Check config has the provider
cat ~/.openclaw/openclaw.json | grep -A5 '"ollama"'

# Restart the gateway and test
```

---

### plugins.slots.memory: plugin not found: memory-core

**Symptom**: Gateway shows error on startup:
```
Invalid config at /home/openclaw/.openclaw/openclaw.json:
- plugins.slots.memory: plugin not found: memory-core
```

**Cause**: OpenClaw's memory slot feature requires the `memory-core` plugin to be in the allowlist and enabled.

**Solution**: Add memory-core plugin configuration to `~/.openclaw/openclaw.json`:

```bash
# In WSL (run: wsl -d openclaw)
python3 << 'EOF'
import json
import os

config_path = os.path.expanduser('~/.openclaw/openclaw.json')
with open(config_path, 'r') as f:
    config = json.load(f)

if 'plugins' not in config:
    config['plugins'] = {}
config['plugins']['allow'] = config['plugins'].get('allow', [])
if 'memory-core' not in config['plugins']['allow']:
    config['plugins']['allow'].append('memory-core')
if 'entries' not in config['plugins']:
    config['plugins']['entries'] = {}
config['plugins']['entries']['memory-core'] = {'enabled': True}
config['plugins']['slots'] = {'memory': 'memory-core'}

with open(config_path, 'w') as f:
    json.dump(config, f, indent=2)
print("Fixed!")
EOF
```

**Note**: Fresh installs from OpenClaw-WSL automatically configure this.
